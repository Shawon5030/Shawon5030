import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

def facebook_number_checker(numbers, delay=5):
    """
    Check multiple Facebook numbers in one function
    Steps:
    1. Enter number and click Search
    2. Wait 5 seconds and check result
    3. If multiple accounts, click second account
    4. If valid, select SMS and click Continue
    5. Wait 5 seconds
    """
    
    # Setup results
    results = {
        'total': len(numbers),
        'checked': 0,
        'valid': 0,
        'captcha': 0,
        'invalid': 0,
        'error': 0
    }
    
    # Setup driver
    options = webdriver.ChromeOptions()
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--disable-blink-features=AutomationControlled')
    options.add_experimental_option("excludeSwitches", ["enable-automation"])
    options.add_experimental_option('useAutomationExtension', False)
    
    driver = webdriver.Chrome(options=options)
    driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
    
    try:
        for i, phone_number in enumerate(numbers):
            print(f"\nüîç Checking {i+1}/{len(numbers)}: {phone_number}")
            
            try:
                # STEP 1: Search number
                driver.get("https://www.facebook.com/login/identify/?ctx=recover")
                
                phone_input = WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.ID, "identify_email"))
                )
                
                phone_input.clear()
                phone_input.send_keys(phone_number)
                
                search_btn = driver.find_element(By.NAME, "did_submit")
                search_btn.click()
                
                print(f"‚úÖ Step 1: Searched for {phone_number}")
                
                # STEP 2: Wait 5 seconds and check result
                time.sleep(5)
                
                # Check for password reset form
                password_form = driver.find_elements(By.XPATH, 
                    "//form[contains(@action, '/ajax/recover/initiate/')]")
                
                # Check for multiple accounts
                account_links = driver.find_elements(By.XPATH, 
                    "//a[contains(@href, 'identify') and contains(text(), 'This is my account')]")
                
                # Check for no account
                no_account = driver.find_elements(By.XPATH, 
                    "//div[contains(text(), 'No search results') or contains(text(), 'not found')]")
                
                # Check for captcha
                captcha = driver.find_elements(By.XPATH, 
                    "//img[contains(@src, 'captcha')]")
                
                # Determine result
                if password_form:
                    result = 'valid'
                    print(f"‚úÖ Step 2: Valid number found")
                    
                elif account_links:
                    # STEP 2a: Click second account if available
                    if len(account_links) > 1:
                        account_links[0].click()
                        time.sleep(3)
                    else:
                        account_links[0].click()
                        time.sleep(3)
               
                    result = 'valid'
                    print(f"‚úÖ Step 2: Multiple accounts handled")
                    
                elif no_account:
                    result = 'invalid'
                    print(f"‚ùå Step 2: No account found")
                    
                elif captcha:
                    result = 'captcha'
                    print(f"üì∏ Step 2: Captcha found")
                    
                else:
                    result = 'unknown'
                    print(f"‚ùì Step 2: Unknown result")
                
                # STEP 3: If valid, select SMS and click Continue
                if result == 'valid':
                    # Check if we're on password reset page
                    reset_form = driver.find_elements(By.XPATH, 
                        "//form[contains(@action, '/ajax/recover/initiate/')]")
                    
                    if reset_form:
                        # Select SMS option
                        sms_radio = driver.find_elements(By.XPATH, 
                            "//input[contains(@id, 'send_sms')]")
                        
                        if sms_radio:
                            sms_radio[0].click()
                            print("‚úÖ SMS option selected")
                        
                        # Click Continue
                        continue_btn = driver.find_element(By.XPATH, 
                            "//button[@name='reset_action' and contains(text(), 'Continue')]")
                        continue_btn.click()
          
                        time.sleep(5)
                        print(f"‚úÖ Step 3: Continued for {phone_number}")
                        
                        
                
            except Exception as e:
                result = 'error'
                print(f"‚ùå Error checking {phone_number}: {str(e)}")
            
            # Update results
            results['checked'] = i + 1
            results[result] += 1
            
            print(f"üìä Result: {result.upper()}")
            print(f"üìà Progress: {i+1}/{len(numbers)} - Valid: {results['valid']}, Invalid: {results['invalid']}, Captcha: {results['captcha']}")
            
            # Delay between numbers (except last one)
            if i < len(numbers) - 1:
                print(f"‚è≥ Waiting {delay} seconds...")
                time.sleep(delay)
        
        # Final results
        print(f"\n‚úÖ COMPLETED! Checked {len(numbers)} numbers")
        print(f"üìä FINAL RESULTS:")
        print(f"   ‚úÖ Valid: {results['valid']}")
        print(f"   ‚ùå Invalid: {results['invalid']}")
        print(f"   üì∏ Captcha: {results['captcha']}")
        print(f"   ‚ö†Ô∏è  Errors: {results['error']}")
        
        return results
        
    finally:
        driver.quit()

# Simple HTML Interface in one function
def create_html_interface():
    """Create simple HTML interface"""
    html = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Facebook Number Checker</title>
        <style>
            body { font-family: Arial; margin: 20px; background: #f5f5f5; }
            .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
            .input-area { margin-bottom: 20px; }
            textarea { width: 100%; height: 150px; padding: 10px; margin-bottom: 10px; }
            .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
            .stat-box { padding: 15px; text-align: center; border-radius: 5px; color: white; }
            .valid { background: #28a745; }
            .invalid { background: #dc3545; }
            .captcha { background: #ffc107; color: black; }
            .error { background: #6c757d; }
            .progress { margin: 20px 0; }
            .progress-bar { height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
            .progress-fill { height: 100%; background: #007bff; transition: width 0.3s; }
            .log { height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa; }
            button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
            .start-btn { background: #28a745; color: white; }
            .stop-btn { background: #dc3545; color: white; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîç Facebook Number Checker</h1>
            
            <div class="input-area">
                <textarea id="numbersInput" placeholder="Enter phone numbers (one per line)"></textarea>
                <br>
                <label>Delay between checks (seconds): </label>
                <input type="number" id="delayInput" value="5" min="2">
                <button class="start-btn" onclick="startChecking()">Start Checking</button>
                <button class="stop-btn" onclick="stopChecking()">Stop</button>
            </div>

            <div class="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div id="progressText">0% (0/0)</div>
            </div>

            <div class="stats">
                <div class="stat-box valid">
                    <div id="validCount">0</div>
                    <div>‚úÖ Valid</div>
                </div>
                <div class="stat-box invalid">
                    <div id="invalidCount">0</div>
                    <div>‚ùå Invalid</div>
                </div>
                <div class="stat-box captcha">
                    <div id="captchaCount">0</div>
                    <div>üì∏ Captcha</div>
                </div>
                <div class="stat-box error">
                    <div id="errorCount">0</div>
                    <div>‚ö†Ô∏è Error</div>
                </div>
            </div>

            <div class="log" id="logArea"></div>
        </div>

        <script>
            function startChecking() {
                const numbers = document.getElementById('numbersInput').value.split('\\n')
                    .map(n => n.trim()).filter(n => n);
                const delay = parseInt(document.getElementById('delayInput').value);
                
                if (numbers.length === 0) {
                    alert('Please enter phone numbers!');
                    return;
                }
                
                simulateChecking(numbers, delay);
            }

            function stopChecking() {
                addLog("Checking stopped by user");
            }

            function simulateChecking(numbers, delay) {
                let checked = 0;
                let valid = 0;
                let invalid = 0;
                let captcha = 0;
                let error = 0;
                
                const interval = setInterval(() => {
                    if (checked >= numbers.length) {
                        clearInterval(interval);
                        addLog("‚úÖ Checking completed!");
                        return;
                    }
                    
                    checked++;
                    const random = Math.random();
                    let result;
                    
                    if (random < 0.4) {
                        valid++;
                        result = 'VALID';
                    } else if (random < 0.6) {
                        invalid++;
                        result = 'INVALID';
                    } else if (random < 0.8) {
                        captcha++;
                        result = 'CAPTCHA';
                    } else {
                        error++;
                        result = 'ERROR';
                    }
                    
                    updateProgress(checked, numbers.length);
                    updateCounts(valid, invalid, captcha, error);
                    addLog(`Step 1: Searched ${numbers[checked-1]}`);
                    addLog(`Step 2: ${result}`);
                    if (result === 'VALID') {
                        addLog(`Step 3: Selected SMS & Continued`);
                    }
                    
                }, delay * 1000);
            }

            function updateProgress(checked, total) {
                const percent = (checked / total) * 100;
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressText').textContent = 
                    `${percent.toFixed(1)}% (${checked}/${total})`;
            }

            function updateCounts(valid, invalid, captcha, error) {
                document.getElementById('validCount').textContent = valid;
                document.getElementById('invalidCount').textContent = invalid;
                document.getElementById('captchaCount').textContent = captcha;
                document.getElementById('errorCount').textContent = error;
            }

            function addLog(message) {
                const logArea = document.getElementById('logArea');
                logArea.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
                logArea.scrollTop = logArea.scrollHeight;
            }
        </script>
    </body>
    </html>
    """
    return html

# Usage Example
if __name__ == "__main__":
    # Example usage
    numbers_to_check = [
        # "01712345678",
        # "01812345678", 
        # "01912345678",
        # "8801712345678"
        "01323915030"
    ]
    
    # Run the checker
    final_results = facebook_number_checker(numbers_to_check, delay=5)
    
    # Save HTML interface to file
    with open("facebook_checker.html", "w", encoding="utf-8") as f:
        f.write(create_html_interface())
    
    print("‚úÖ HTML interface saved as 'facebook_checker.html'")
